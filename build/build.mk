JS_FILES += js/types.js
JS_FILES += js/messages.js
JS_FILES += js/nodes.js

RS_FILES += bindings/src/lib.rs
RS_FILES += bindings/src/messages.rs
RS_FILES += bindings/src/nodes.rs

ifndef TARGET
$(error TARGET variable is required)
endif

ifeq ($(TARGET),nodejs)
else
ifeq ($(TARGET),no-modules)
else
$(error TARGET can only be `nodejs` or `no-modules`, but `$(TARGET)` was passed)
endif
endif

$(info TARGET = $(TARGET))

RUN_WASM_PACK = cd bindings && \
	wasm-pack build --target $(TARGET) && \
	cd .. && \
	mkdir -p build/$(TARGET) && \
	echo "*" > build/$(TARGET)/.gitignore && \
	cp bindings/pkg/lib_ruby_parser_wasm.js build/$(TARGET)/lib_ruby_parser_wrapper.js && \
	cp bindings/pkg/lib_ruby_parser_wasm_bg.wasm build/$(TARGET)/lib_ruby_parser.wasm

# WASM wrapper generated by wasm-pack
build/$(TARGET)/lib_ruby_parser_wrapper.js: $(RS_FILES)
	$(RUN_WASM_PACK)

build/$(TARGET)/lib_ruby_parser.wasm: $(RS_FILES)
	$(RUN_WASM_PACK)

build/$(TARGET)/lib_ruby_parser.js: build/scripts/merge.js build/$(TARGET)/lib_ruby_parser_wrapper.js $(JS_FILES)
	node build/scripts/merge.js

CLEAN += build/no-modules
CLEAN += build/nodejs
